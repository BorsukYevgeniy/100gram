generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          Int          @id @default(autoincrement())
  email       String       @unique
  nickname    String       @unique
  password    String
  avatar      String       @default("DEFAULT_USER_AVATAR.png")
  createdAt   DateTime     @default(now())
  role        Role         @default(USER)
  messages    Message[]
  chatToUsers ChatToUser[]
  tokens      Token[]
  // Chats where the user is the owner
  chatsOwned  Chat[]

  isVerified       Boolean             @default(false)
  verifiedAt       DateTime?
  verificationCode String              @unique @default(uuid())
  files            File[]
  reactions        ReactionToMessage[]
}

model Message {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())

  reactions ReactionToMessage[]

  files File[]

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  chatId Int
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
}

model ChatToUser {
  chatId Int
  userId Int

  connectedAt DateTime @default(now())

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([chatId, userId])
}

model Chat {
  id          Int     @id @default(autoincrement())
  avatar      String  @default("DEFAULT_CHAT_AVATAR.png")
  title       String?
  description String?

  messages    Message[]
  chatToUsers ChatToUser[]
  chatType    ChatType

  ownerId Int?
  owner   User? @relation(fields: [ownerId], references: [id])

  // Private chats dont have owner, avatar, title and description
}

model Token {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model File {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())

  messageId Int?
  message   Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  userId Int?
  user   User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model ReactionToMessage {
  messageId Int
  userId    Int

  createdAt DateTime @default(now())
  reaction  Reaction

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId])
}

enum Reaction {
  LIKE
  DISLIKE
  FIRE
  HEART
  HEART_WITH_FIRE
}

enum ChatType {
  PRIVATE
  GROUP
}

enum Role {
  ADMIN
  USER
}
